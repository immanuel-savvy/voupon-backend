let ADMINSTRATORS,ADMIN_HASH,CONTACT_MESSAGES,GLOBALS,USERS,USERS_HASH,WALLETS,GLOBAL_subscriptions,GLOBAL_pending_user_verification;_43d‍.x([["remove_subscriber",()=>remove_subscriber],["create_default_admin",()=>create_default_admin],["subscribe_newsletter",()=>subscribe_newsletter],["contact_messages",()=>contact_messages],["new_contact_message",()=>new_contact_message],["newsletter_subscribers",()=>newsletter_subscribers],["remove_contact_messages",()=>remove_contact_messages],["contact_message_seen",()=>contact_message_seen],["GLOBAL_newsletter",()=>GLOBAL_newsletter],["GLOBAL_pending_vendors",()=>GLOBAL_pending_vendors],["default_wallet",()=>default_wallet],["default_user",()=>default_user]]);_43d‍.w("../ds/conn",[["ADMINSTRATORS",["ADMINSTRATORS"],function(v){ADMINSTRATORS=v}],["ADMIN_HASH",["ADMIN_HASH"],function(v){ADMIN_HASH=v}],["CONTACT_MESSAGES",["CONTACT_MESSAGES"],function(v){CONTACT_MESSAGES=v}],["GLOBALS",["GLOBALS"],function(v){GLOBALS=v}],["USERS",["USERS"],function(v){USERS=v}],["USERS_HASH",["USERS_HASH"],function(v){USERS_HASH=v}],["WALLETS",["WALLETS"],function(v){WALLETS=v}]]);_43d‍.w("./marketplace",[["GLOBAL_subscriptions",["GLOBAL_subscriptions"],function(v){GLOBAL_subscriptions=v}]]);_43d‍.w("./users",[["GLOBAL_pending_user_verification",["GLOBAL_pending_user_verification"],function(v){GLOBAL_pending_user_verification=v}]]);











let default_admin = "adminstrators~123voupon~1234567890123",
  default_user = "users~123voupon~1234567890123",
  default_wallet;

const GLOBAL_newsletter = "newsletter",
  GLOBAL_unseen_messages = "contact_messages",
  GLOBAL_pending_vendors = "pending_vendors";

const create_default_admin = () => {
  if (!_43d‍.a("ADMINSTRATORS",ADMINSTRATORS).readone(default_admin)) {
    _43d‍.a("ADMINSTRATORS",ADMINSTRATORS).write({
      firstname: "Voupon",
      lastname: "Africa",
      image: "logo_single.png",
      email: "admin@voupon.com",
      _id: default_admin,
    });
    _43d‍.a("ADMIN_HASH",ADMIN_HASH).write({ admin: default_admin, key: "adminstrator#1" });
  }

  let user_ = _43d‍.a("USERS",USERS).readone(default_user);
  if (!user_) {
    _43d‍.a("USERS",USERS).write({
      _id: default_user,
      firstname: "Voupon",
      lastname: "Africa",
      verified: true,
      email: "vouponafrica@gmail.com",
    });
    _43d‍.a("USERS_HASH",USERS_HASH).write({ user: default_user, key: "adminstrator#1" });
  } else if (!user_.wallet) {
    let wallet = _43d‍.a("WALLETS",WALLETS).write({ user: default_user });

    _43d‍.u(_43d‍.u(default_wallet = wallet._id));
    _43d‍.a("USERS",USERS).update(default_user, { wallet: default_wallet });
  }

  !_43d‍.a("GLOBALS",GLOBALS).readone({ global: GLOBAL_pending_vendors }) &&
    _43d‍.a("GLOBALS",GLOBALS).write({ global: GLOBAL_pending_vendors, vendors: new Array() });

  !_43d‍.a("GLOBALS",GLOBALS).readone({ global: GLOBAL_pending_user_verification }) &&
    _43d‍.a("GLOBALS",GLOBALS).write({
      global: GLOBAL_pending_user_verification,
      users: new Array(),
    });

  !_43d‍.a("GLOBALS",GLOBALS).readone({ global: GLOBAL_subscriptions }) &&
    _43d‍.a("GLOBALS",GLOBALS).write({
      global: GLOBAL_subscriptions,
      active: true,
      subscribers: new Array(),
    });
};

const subscribe_newsletter = (req, res) => {
  let { email } = req.body;
  if (email && typeof email === "string") {
    email = email.trim().toLowerCase();
    if (_43d‍.a("GLOBALS",GLOBALS).readone({ global: GLOBAL_newsletter }))
      _43d‍.a("GLOBALS",GLOBALS).update(
        { global: GLOBAL_newsletter },
        { subscribers: { $set: email } }
      );
    else {
      _43d‍.a("GLOBALS",GLOBALS).write({
        global: GLOBAL_newsletter,
        subscribers: new Array(email),
      });
    }
  }

  res.end();
};

const remove_subscriber = (req, res) => {
  let { email } = req.body;

  email &&
    typeof email === "string" &&
    _43d‍.a("GLOBALS",GLOBALS).update(
      { global: GLOBAL_newsletter },
      { subscribers: { $splice: email.trim().toLowerCase() } }
    );

  res.end();
};

const newsletter_subscribers = (req, res) => {
  let subscribers = _43d‍.a("GLOBALS",GLOBALS).readone({ global: GLOBAL_newsletter });
  res.json({
    ok: true,
    message: "newsletter subscribers",
    data: subscribers ? subscribers.subscribers : new Array(),
  });
};

const contact_messages = (req, res) => {
  let { seen } = req.body || new Object();

  let msgs = (
      _43d‍.a("GLOBALS",GLOBALS).read({ global: GLOBAL_unseen_messages }) || {
        messages: new Array(),
      }
    ).messages,
    messages;
  messages = seen
    ? _43d‍.a("CONTACT_MESSAGES",CONTACT_MESSAGES).read({ _id: { $ne: msgs } })
    : _43d‍.a("CONTACT_MESSAGES",CONTACT_MESSAGES).read(msgs);

  res.json({ ok: true, message: "contact messages fetched", data: messages });
};

const remove_contact_messages = (req, res) => {
  let { message } = req.params;

  _43d‍.a("CONTACT_MESSAGES",CONTACT_MESSAGES).remove(message);
  res.end();
};

const contact_message_seen = (req, res) => {
  let { message } = req.params;

  _43d‍.a("GLOBALS",GLOBALS).update(
    { global: GLOBAL_unseen_messages },
    { messages: { $splice: message } }
  );
  _43d‍.a("CONTACT_MESSAGES",CONTACT_MESSAGES).update(message, { seen: true });

  res.end();
};

const new_contact_message = (req, res) => {
  let message = req.body;

  let result = _43d‍.a("CONTACT_MESSAGES",CONTACT_MESSAGES).write(message);
  if (_43d‍.a("GLOBALS",GLOBALS).readone({ global: GLOBAL_unseen_messages }))
    _43d‍.a("GLOBALS",GLOBALS).update(
      { global: GLOBAL_unseen_messages },
      { messages: { $push: result._id } }
    );
  else
    _43d‍.a("GLOBALS",GLOBALS).write({
      global: GLOBAL_unseen_messages,
      messages: new Array(result._id),
    });

  res.end();
};














;_43d‍.j(["remove_subscriber","create_default_admin","subscribe_newsletter","contact_messages","new_contact_message","newsletter_subscribers","remove_contact_messages","contact_message_seen","GLOBAL_newsletter","GLOBAL_pending_vendors","default_wallet","default_user"]);
