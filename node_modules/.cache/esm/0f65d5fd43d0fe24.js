let axios,_id,OFFER_VOUCHERS,OPEN_VOUCHERS,PURCHASED_VOUCHERS,REDEEMED_VOUCHERS,TRANSACTIONS,USERS,USER_VOUCHERS,VENDORS,VOUCHERS,WALLETS,generate_random_string,shuffle_array,paystack_secret_key,voucher_otp_email,voucher_purchased_email,voucher_redeemed_email,default_wallet,send_mail,save_image,rewards;_43d‍.x([["get_offer_vouchers",()=>get_offer_vouchers],["create_offer_voucher",()=>create_offer_voucher],["create_open_voucher",()=>create_open_voucher],["voucher_availability",()=>voucher_availability],["offer_vouchers",()=>offer_vouchers],["verify_voucher",()=>verify_voucher],["voucher_page",()=>voucher_page],["open_vouchers",()=>open_vouchers],["update_voucher",()=>update_voucher],["voucher_purchased",()=>voucher_purchased],["user_vouchers",()=>user_vouchers],["redeem_voucher",()=>redeem_voucher],["can_redeem_voucher",()=>can_redeem_voucher],["request_voucher_otp",()=>request_voucher_otp],["transfer_voucher",()=>transfer_voucher],["remove_from_closed_voucher",()=>remove_from_closed_voucher],["close_voucher",()=>close_voucher],["parse_vendor_id",()=>parse_vendor_id],["reset_vendor_id",()=>reset_vendor_id],["use_voucher",()=>use_voucher],["vendor_id",()=>vendor_id],["generate_voucher_otp",()=>generate_voucher_otp],["unmask_id",()=>unmask_id],["mask_id",()=>mask_id]]);_43d‍.w("axios",[["default",["axios"],function(v){axios=v}]]);_43d‍.w("generalised-datastore/utils/functions",[["_id",["_id"],function(v){_id=v}]]);_43d‍.w("../ds/conn",[["OFFER_VOUCHERS",["OFFER_VOUCHERS"],function(v){OFFER_VOUCHERS=v}],["OPEN_VOUCHERS",["OPEN_VOUCHERS"],function(v){OPEN_VOUCHERS=v}],["PURCHASED_VOUCHERS",["PURCHASED_VOUCHERS"],function(v){PURCHASED_VOUCHERS=v}],["REDEEMED_VOUCHERS",["REDEEMED_VOUCHERS"],function(v){REDEEMED_VOUCHERS=v}],["TRANSACTIONS",["TRANSACTIONS"],function(v){TRANSACTIONS=v}],["USERS",["USERS"],function(v){USERS=v}],["USER_VOUCHERS",["USER_VOUCHERS"],function(v){USER_VOUCHERS=v}],["VENDORS",["VENDORS"],function(v){VENDORS=v}],["VOUCHERS",["VOUCHERS"],function(v){VOUCHERS=v}],["WALLETS",["WALLETS"],function(v){WALLETS=v}]]);_43d‍.w("../functions",[["generate_random_string",["generate_random_string"],function(v){generate_random_string=v}],["shuffle_array",["shuffle_array"],function(v){shuffle_array=v}]]);_43d‍.w("./admin",[["paystack_secret_key",["paystack_secret_key"],function(v){paystack_secret_key=v}]]);_43d‍.w("./emails",[["voucher_otp_email",["voucher_otp_email"],function(v){voucher_otp_email=v}],["voucher_purchased_email",["voucher_purchased_email"],function(v){voucher_purchased_email=v}],["voucher_redeemed_email",["voucher_redeemed_email"],function(v){voucher_redeemed_email=v}]]);_43d‍.w("./starter",[["default_wallet",["default_wallet"],function(v){default_wallet=v}]]);_43d‍.w("./users",[["send_mail",["send_mail"],function(v){send_mail=v}]]);_43d‍.w("./utils",[["save_image",["save_image"],function(v){save_image=v}]]);_43d‍.w("./wallets",[["rewards",["rewards"],function(v){rewards=v}]]);

























/**
 * @api {post} /vendor_id Vendor ID
 * @apiName identification
 * @apiGroup Get Started
 * @apiDescription Vendor ID can also be found in the vendor profile.
 * @apiBody {string} email Vendor email address
 * @apiSuccessExample {json} Successful Response:
 * {
 *    "ok": true,
 *    "message": "vendor ID"
 *    "data":{
 *      "vendor_id":"16764$Jimt9GmEFdjUCO1$61418603"
 *     }
 * }
 */

const voucher_otp = new Object();

const parse_vendor_id = (vendor_id) => {
  vendor_id = vendor_id.split("~");
  vendor_id.splice(0, 1);
  vendor_id.unshift(vendor_id[1].slice(5));
  vendor_id[2] = vendor_id[2].slice(0, 5);

  return vendor_id.join("$");
};

const reset_vendor_id = (vendor_id, folder) => {
  vendor_id = vendor_id.split("$");
  vendor_id = [
    folder || "vendors",
    vendor_id[1],
    `${vendor_id[2]}${vendor_id[0]}`,
  ];

  return vendor_id.join("~");
};

const mask_id = (_id) => parse_vendor_id(_id);

const unmask_id = (_id, folder) => _id && reset_vendor_id(_id, folder);

const vendor_id = (req, res) => {
  let { email } = req.body;

  let user = _43d‍.a("USERS",USERS).readone({ email });
  if (!user)
    return res.json({ ok: false, message: "user not found", data: { email } });

  if (!user.vendor || (user.vendor && user.vendor_status !== "verified"))
    res.json({ ok: false, message: "user vendor invalid", data: { email } });

  let vendor = _43d‍.a("VENDORS",VENDORS).readone(user.vendor);

  res.json({
    ok: true,
    message: "vendor ID",
    data: { vendor_id: parse_vendor_id(vendor._id) },
  });
};

const create_offer_voucher = (req, res) => {
  let voucher = req.body;

  voucher.images = voucher.images.map((img) => {
    img.url = _43d‍.a("save_image",save_image)(img.url);

    return img;
  });
  let result = _43d‍.a("OFFER_VOUCHERS",OFFER_VOUCHERS).write(voucher);
  voucher._id = result._id;
  voucher.created = result.created;

  _43d‍.a("VENDORS",VENDORS).update(voucher.vendor, { vouchers: { $inc: 1 } });

  res.json({
    ok: true,
    message: "offer_voucher",
    data: voucher,
  });
};

const offer_vouchers = (req, res) => {
  let { vendor } = req.params;

  res.json({
    ok: true,
    message: "vouchers",
    data: _43d‍.a("OFFER_VOUCHERS",OFFER_VOUCHERS).read({ vendor }),
  });
};

const open_vouchers = (req, res) => {
  let { user } = req.params;

  res.json({
    ok: true,
    message: "vouchers",
    data: _43d‍.a("OPEN_VOUCHERS",OPEN_VOUCHERS).read({ user }),
  });
};

const get_offer_vouchers = (req, res) => {
  let { limit } = req.params;

  let vendors = _43d‍.a("VENDORS",VENDORS).read();

  let vouchers = new Array();

  vendors.map((vendor) =>
    vouchers.push(
      ...OFFER_VOUCHERS.read({
        vendor: vendor._id,
        duration: { $gt: Date.now() },
        quantities: { $gt: 0 },
        state: { $ne: "closed" },
      })
    )
  );

  _43d‍.a("shuffle_array",shuffle_array)(vouchers);

  let n = new Object();
  vendors.map((v) => (n[v._id] = v));
  res.json({
    ok: true,
    message: "offer vouchers",
    data: { vendors: n, vouchers, total: _43d‍.a("OFFER_VOUCHERS",OFFER_VOUCHERS).config.total_entries },
  });
};

const voucher_purchased = (req, res) => {
  let details = req.body;

  let voucher_code = _43d‍.a("generate_random_string",generate_random_string)(6, "alpha").toUpperCase();
  while (_43d‍.a("PURCHASED_VOUCHERS",PURCHASED_VOUCHERS).readone({ voucher_code }))
    voucher_code = _43d‍.a("generate_random_string",generate_random_string)(6, "alpha").toUpperCase();

  let vendor = _43d‍.a("VENDORS",VENDORS).readone(details.vendor);
  if (vendor.suspended)
    return res.json({
      ok: false,
      data: { message: "Cannot purchase from Vendor at the moment." },
    });

  let result = _43d‍.a("PURCHASED_VOUCHERS",PURCHASED_VOUCHERS).write({
    ...details,
    voucher_code,
  });

  let offer_voucher = _43d‍.a("OFFER_VOUCHERS",OFFER_VOUCHERS).update(
    { _id: details.voucher, vendor: details.vendor },
    {
      total_sales: { $inc: 1 },
      quantities: { $dec: 1 },
    }
  );

  delete offer_voucher.total_sales;
  delete offer_voucher.quantities;

  offer_voucher.offer_voucher = offer_voucher._id;
  offer_voucher.user = details.user;

  delete offer_voucher._id;
  delete offer_voucher.created;
  delete offer_voucher.updated;

  offer_voucher.email = details.email;
  let voucher = _43d‍.a("VOUCHERS",VOUCHERS).write(offer_voucher);
  details.voucher = voucher._id;

  _43d‍.a("USER_VOUCHERS",USER_VOUCHERS).write({
    voucher: details.voucher,
    user: details.user,
    email: details.email,
    voucher_code,
    value: offer_voucher.value,
    state: "unused",
  });

  let tx = {
    voucher: details.voucher,
    user: details.user,
    type: "voucher",
    title: "voucher purchased",
    vendor: details.vendor,
    voucher_code,
    value: offer_voucher.value,
    credit: true,
  };

  _43d‍.a("TRANSACTIONS",TRANSACTIONS).write(tx);

  _43d‍.a("send_mail",send_mail)({
    recipient: details.email,
    recipient_name: `${details.firstname} ${details.lastname}`,
    subject: "[Voucher Africa] Voucher Purchased",
    html: _43d‍.a("voucher_purchased_email",voucher_purchased_email)({ ...details, voucher_code }),
  });

  _43d‍.a("send_mail",send_mail)({
    recipient: vendor.email,
    recipient_name: `${vendor.name}`,
    subject: "[Voucher Africa] New Voucher Purchased",
    html: _43d‍.a("voucher_purchased_email",voucher_purchased_email)({ ...details, ...vendor, voucher_code }),
  });

  res.json({
    ok: true,
    message: "voucher purchased",
    data: { voucher_code, _id: result._id, created: result.created },
  });
};

const voucher_creation_fees = (details) => {
  let user = _43d‍.a("USERS",USERS).readone(details.user);
  let fee = user.premium ? 50 : 100;
  _43d‍.a("WALLETS",WALLETS).update(_43d‍.a("default_wallet",default_wallet), {
    total_earning: { $inc: fee },
    balance: { $inc: fee },
  });

  _43d‍.a("TRANSACTIONS",TRANSACTIONS).write({
    wallet: default_wallet,
    value: fee,
    type: "voucher",
    title: "Voucher Created",
    user: user._id,
    credit: true,
  });

  if (user.referral) {
    let ref_fee = fee * 0.1;
    let ref = _43d‍.a("USERS",USERS).readone(user._id);
    _43d‍.a("WALLETS",WALLETS).update(ref.wallet, { balance: { $inc: ref_fee } });
    _43d‍.a("TRANSACTIONS",TRANSACTIONS).write({
      wallet: ref.wallet,
      value: ref_fee,
      type: "voucher",
      title: "Affiliate Created Voucher",
      user: ref._id,
      credit: true,
    });

    _43d‍.a("WALLETS",WALLETS).update(_43d‍.a("default_wallet",default_wallet), {
      balance: { $dec: ref_fee },
      total_disburse: { $inc: ref_fee },
    });

    _43d‍.a("TRANSACTIONS",TRANSACTIONS).write({
      wallet: default_wallet,
      value: ref_fee,
      type: "voucher",
      title: "Paid out referral created voucher",
      user: ref._id,
    });
  }
};

const create_open_voucher = (req, res) => {
  let details = req.body;

  let voucher_code = _43d‍.a("generate_random_string",generate_random_string)(6, "alpha").toUpperCase();

  details.voucher_code = voucher_code;
  let result = _43d‍.a("VOUCHERS",VOUCHERS).write(details);
  details._id = result._id;
  details.created = result.created;

  result = _43d‍.a("OPEN_VOUCHERS",OPEN_VOUCHERS).write({
    voucher: details._id,
    user: details.user,
    value: details.value,
    voucher_code,
  });
  result = {
    _id: result._id,
    created: result.created,
    voucher: details,
    voucher_code,
    user: details.user,
  };

  voucher_creation_fees(details);
  let user = _43d‍.a("USERS",USERS).readone(details.user);

  _43d‍.a("send_mail",send_mail)({
    recipient: details.email,
    recipient_name: `${user.firstname} ${user.lastname}`,
    subject: "[Voucher Africa] Voucher Purchased",
    sender: "signup@udaralinksapp.com",
    sender_name: "Voupon",
    sender_pass: "signupudaralinks",
    html: _43d‍.a("voucher_purchased_email",voucher_purchased_email)({ ...details, voucher_code }),
  });

  res.json({
    ok: true,
    message: "open_voucher",
    data: result,
  });
};

const user_vouchers = (req, res) => {
  let { user } = req.params;

  let open_vouchers = _43d‍.a("OPEN_VOUCHERS",OPEN_VOUCHERS).read({ user }),
    offer_vouchers = _43d‍.a("USER_VOUCHERS",USER_VOUCHERS).read({ user });

  res.json({
    ok: true,
    message: "user vouchers",
    data: { open_vouchers, offer_vouchers },
  });
};

/**
 * @apiDefine offer_voucher Vouchers that are created by a vendor for a precise service
 * @apiDefine open_voucher Vouchers user created and ready to be used by any available vendor
 *
 * */

/**
 * @api {post} /verify_voucher_for_transaction Verify Voucher
 * @apiName VerifyVoucherIsTransactable
 * @apiGroup Vouchers
 *
 * @apiDescription You can confirm the state of a voucher with respect to a transaction value, to note if a user has the value for the service to be offered before hand.
 *
 * @apiBody {string} voucher_code Voucher Code
 * @apiBody {string} voucher_type='offer_voucher' Voucher Type
 * @apiBody {string} [vendor] Vendor ID - as in the case of an Offer Voucher
 * @apiBody {string} email User registered email
 * @apiBody {number} [amount] Amount to confirm voucher against
 *
 */

const can_redeem_voucher = (
  req,
  res,
  minimal = false,
  donot_use_response = false
) => {
  let { voucher_code, vendor, email, amount, user, voucher_type } = req.body;

  voucher_type = voucher_type && voucher_type.replace(/ /g, "_");

  if (!user && !email) {
    return res.json({
      ok: false,
      data: { message: "No user credentials found!" },
    });
  }
  if (!user && email) {
    user = _43d‍.a("USERS",USERS).readone({ email });
    if (!user)
      return res.json({ ok: false, data: { message: "User not found" } });

    user = user._id;
  }

  if (!new Array("open_voucher", "offer_voucher").includes(voucher_type))
    return res.json({
      ok: false,
      data: { message: "Voucher type is invalid" },
    });

  let voucher = (
    voucher_type === "offer_voucher" ? _43d‍.a("USER_VOUCHERS",USER_VOUCHERS) : _43d‍.a("OPEN_VOUCHERS",OPEN_VOUCHERS)
  ).readone({ user, voucher_code });

  if (!voucher)
    return res.json({
      ok: false,
      message: "cannot redeem voucher",
      data: { message: "Voucher not found" },
    });

  if (voucher_type === "offer_voucher") {
    if (vendor && voucher.voucher.vendor._id !== vendor) {
      return res.json({
        ok: false,
        data: { message: "Voucher does not belong to vendor." },
      });
    }

    if (voucher.state !== "unused")
      return res.json({
        ok: false,
        data: { message: `Voucher has already been ${voucher.state}` },
      });
  } else {
    if (voucher.voucher.value <= 0)
      return res.json({
        ok: false,
        data: { message: "Voucher has no balance" },
      });
    if (Number(amount) > 0 && voucher.voucher.value < Number(amount))
      return res.json({
        ok: false,
        data: {
          message: `Voucher has insufficient balance, Available balance is - ${voucher.voucher.value}`,
        },
      });
    else if (Number(amount) && Number(amount) < 0)
      return res.json({
        ok: false,
        data: { message: "Invalid amount data" },
      });
    if (voucher.state && voucher.state !== "unused") {
      return res.json({
        ok: false,
        data: { message: `Voucher has already been ${voucher.state}` },
      });
    }
  }

  if (!donot_use_response)
    res.json({
      ok: true,
      message: minimal ? "success" : "can redeem voucher",
      data: minimal
        ? {
            can_transact: true,
            voucher_code: voucher.voucher_code,
            voucher_type: voucher_type,
          }
        : {
            can_redeem: true,
            owner_voucher: voucher._id,
            user: voucher.user,
            voucher: voucher.voucher._id,
            email,
            voucher_type,
            voucher_code: voucher.voucher_code,
            voucher_details: voucher,
          },
    });
  else return "proceed";
};

/**
 * @api {post} /redeem_voucher Redeem voucher
 * @apiName RedeemVoucher
 * @apiGroup Vouchers
 *
 * @apiDescription To redeem a voucher, you ought to have generated a One-Time Password from the /request_voucher_otp endpoint
 *
 * @apiBody {string} voucher_code Voucher Code
 * @apiBody {string} voucher_type Voucher Type [`offer_voucher` | `open_voucher`]
 * @apiBody {number} otp Voucher One-Time Password
 * @apiBody {string} bank Bank.code from /get_banks endpoint
 * @apiBody {string} account_number Account number to deposit voucher value into
 * @apiBody {string} email Registered email of user whose voucher it is
 *
 *
 */

const redeem_voucher = (req, res) => {
  let details = req.body;

  let {
    voucher_code,
    voucher_type,
    otp,
    bank,
    account_number,
    email,
    user,
    voucher,
  } = details;

  if (!user) {
    user = _43d‍.a("USERS",USERS).readone({ email });

    if (!user)
      return res.json({
        ok: false,
        message: "user not found",
        data: { user, email },
      });

    user = user._id;
  }

  voucher = (
    voucher_type === "open_voucher" ? _43d‍.a("OPEN_VOUCHERS",OPEN_VOUCHERS) : _43d‍.a("USER_VOUCHERS",USER_VOUCHERS)
  ).readone(!voucher ? { voucher_code, user } : { _id: voucher, user });

  if (Number(otp) !== Number(voucher_otp[voucher._id]))
    return res.json({
      ok: false,
      message: "voucher otp incorrect",
      data: { message: "voucher otp invalid" },
    });
  delete voucher_otp[voucher._id];

  let reference = _43d‍.a("generate_random_string",generate_random_string)(20, "alnum");

  let { _id } = voucher;
  let user_ = _43d‍.a("USERS",USERS).readone(user);
  let { firstname, lastname, referral } = user_;
  email = email || user_.email;

  let { value } = voucher;
  voucher = voucher.voucher;

  if (!voucher) return res.json({ ok: false, message: "voucher not found" });
  if (voucher.state && voucher.state !== "unused")
    return res.json({
      ok: false,
      data: { message: "Voucher is not `unused`" },
    });

  if (!email) {
    email = _43d‍.a("USERS",USERS).readone(user);
    email = email && email.email;
    if (!email)
      return res.json({ ok: false, data: { message: "Email not found" } });
  }

  _43d‍.a("axios",axios)({
    url: "https://api.paystack.co/transferrecipient",
    method: "post",
    headers: {
      Authorization: `Bearer ${_43d‍.a("paystack_secret_key",paystack_secret_key)}`,
      "Content-Type": "application/json",
    },
    data: {
      type: "nuban",
      name: `${firstname} ${lastname}`,
      account_number,
      bank_code: bank,
      currency: "NGN",
    },
  })
    .then((result) => {
      result = result.data;

      let recipient = result.data.recipient_code;
      value = Number(value);

      _43d‍.a("axios",axios)({
        url: "https://api.paystack.co/transfer",
        method: "post",
        headers: {
          Authorization: `Bearer ${_43d‍.a("paystack_secret_key",paystack_secret_key)}`,
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        data: {
          source: "balance",
          amount: value - _43d‍.a("rewards",rewards).voucher_redeemed_fee,
          recipient,
        },
      })
        .then((result) => {
          result = result.data;

          if (voucher_type === "open_voucher")
            _43d‍.a("VOUCHERS",VOUCHERS).update(voucher._id, { redeemed: true, state: "redeemed" });

          (voucher_type === "offer_voucher"
            ? _43d‍.a("USER_VOUCHERS",USER_VOUCHERS)
            : _43d‍.a("OPEN_VOUCHERS",OPEN_VOUCHERS)
          ).update({ user, _id }, { state: "redeemed" });

          _43d‍.a("REDEEMED_VOUCHERS",REDEEMED_VOUCHERS).write({
            voucher: voucher._id,
            transfer_details: {
              recipient,
              reference: result.data.reference,
              transfer_code: result.data.transfer_code,
              reference,
              email,
            },
            transfer_status: null,
          });

          let tx = {
            voucher: _id,
            type: "voucher",
            user,
            title: "voucher redeemed",
            vendor: voucher.vendor,
            voucher_code: voucher_code,
            value: value - _43d‍.a("rewards",rewards).voucher_redeemed_fee,
            wallet: _43d‍.a("USERS",USERS).readone(user).wallet,
          };

          _43d‍.a("TRANSACTIONS",TRANSACTIONS).write(tx);

          let tx_fee = _43d‍.a("rewards",rewards).voucher_redeemed_fee;
          if (referral) {
            referral = _43d‍.a("USERS",USERS).readone(referral);

            tx_fee = tx_fee - tx_fee * (referral.premium ? 0.2 : 0.1);
          }

          _43d‍.a("WALLETS",WALLETS).update(_43d‍.a("default_wallet",default_wallet), {
            balance: { $inc: tx_fee },
            total_earning: { $inc: tx_fee },
          });
          _43d‍.a("TRANSACTIONS",TRANSACTIONS).write({
            voucher: _id,
            type: "voucher",
            user,
            title: "voucher redeemed fee",
            vendor: voucher.vendor,
            voucher_code: voucher_code,
            value: tx_fee,
            wallet: default_wallet,
          });

          if (referral) {
            let ref_fee = _43d‍.a("rewards",rewards).voucher_redeemed_fee - tx_fee;
            _43d‍.a("WALLETS",WALLETS).update(referral.wallet, {
              balance: { $inc: ref_fee },
              vouchers: { $inc: ref_fee },
            });
            _43d‍.a("TRANSACTIONS",TRANSACTIONS).write({
              voucher: _id,
              type: "voucher",
              user,
              title: "voucher redeemed referral token",
              vendor: voucher.vendor,
              voucher_code: voucher_code,
              value: ref_fee,
              wallet: referral.wallet,
            });
          }

          _43d‍.a("send_mail",send_mail)({
            recipient: email,
            recipient_name: `${firstname} ${lastname}`,
            subject: "[Voucher Africa] Voucher Redeemed",
            html: _43d‍.a("voucher_redeemed_email",voucher_redeemed_email)({ ...details, voucher_code }),
          });

          res.json({
            ok: true,
            message: "voucher redeemed",
            data: { voucher: _id, redeemed: true },
          });
        })
        .catch((err) => _43d‍.g.console.log(err, "HERE"));
    })
    .catch((err) => _43d‍.g.console.log(err, "H#$#"));
};

/**
 * @api {post} /generate_voucher_otp Generate Voucher OTP
 * @apiName GenerateVoucherOTP
 * @apiGroup Vouchers
 *
 * @apiDescription Once this is called, an OTP is generated and sent to the authorised email linked to the voucher, the user is to return this OTP for verification.
 *
 * @apiBody {String} voucher_code Voucher Code
 * @apiBody {String} voucher_type Voucher Type [`offer_voucher` | `open_voucher`]
 * @apiBody {String} email User email linked to voucher
 * @apiBody {String} [value] Only required if voucher_type is `open_voucher`
 *
 * @apiSuccessExample {json} Success Response:
 *  {
 *     "ok": true,
 *     "message": "voucher otp sent",
 *     "data": {
 *       "voucher": "user_vouchers~xMexATpLEj03Z~1678358344593",
 *       "email": "immanuelsavvy@gmail.com",
 *       "user": "users~DuqM6Sef1vqIofd5n~1675764912550"
 *     }
 *   }
 *
 */
const generate_voucher_otp = (req, res) => {
  let proceed = can_redeem_voucher({ body: req.body }, res, true, true);

  if (proceed !== "proceed") return;

  request_voucher_otp(req, res);
};

const request_voucher_otp = (req, res) => {
  let { voucher_code, user, voucher_type, email } = req.body;

  if (!user && email) {
    user = _43d‍.a("USERS",USERS).readone({ email });
    user = user && user._id;

    if (!user) return res.json({ ok: false, message: "User not found" });
  } else if (!email && user) email = _43d‍.a("USERS",USERS).readone(user).email;

  let code = _43d‍.a("generate_random_string",generate_random_string)(6, "num");
  let voucher = (
    voucher_type === "open_voucher" ? _43d‍.a("OPEN_VOUCHERS",OPEN_VOUCHERS) : _43d‍.a("USER_VOUCHERS",USER_VOUCHERS)
  ).readone({ user, voucher_code });

  if (!voucher) return res.json({ ok: false });

  voucher_otp[voucher._id] = Number(code);

  let { _id } = voucher;
  let { firstname, lastname } = _43d‍.a("USERS",USERS).readone(user);

  if (!email) {
    email = _43d‍.a("USERS",USERS).readone(user);
    email = email && email.email;
    if (!email)
      return res.json({ ok: false, data: { message: "Email not found" } });
  }

  _43d‍.a("send_mail",send_mail)({
    recipient: email,
    recipient_name: `${firstname} ${lastname}`,
    subject: "[Voucher Africa] Voucher OTP",
    html: _43d‍.a("voucher_otp_email",voucher_otp_email)({ ...voucher, code }),
  });

  res.json({
    ok: true,
    message: "voucher otp sent",
    data: { voucher: _id, email, user },
  });
};

/**
 * @api {post} /transfer_voucher Transfer Voucher Ownership
 * @apiName TransferVoucher
 * @apiGroup Vouchers
 *
 * @apiDescription Transfer voucher ownership from one user to another.
 *
 * @apiBody {Number} otp Voucher one time password; You must have queried the /request_voucher_otp to provide to OTP to the user email
 * @apiBody {String} destination_email New user email to be used as voucher's authorised email
 * @apiBody {String} owner Current email linked to voucher
 * @apiBody {String} voucher_type [`offer_voucher` | `open_voucher`]
 * @apiBody {String} voucher Voucher returned from success response of /request_voucher_otp
 *
 * @apiSuccessExample {json} Successful-Response:
 *  {
 *    ok: true,
 *    message: "transfer voucher",
 *    data: {
 *      voucher: "user_vouchers~eccevnivnwiioieiwcw~239485020201",
 *      transferred: true,
 *    },
 *  }
 */
const transfer_voucher = (req, res) => {
  let details = req.body;

  let { otp, email2, user, destination_email, owner, voucher_type, voucher } =
    details;
  email2 = email2 || destination_email;

  if (Number(otp) !== Number(voucher_otp[voucher]))
    return res.json({
      ok: false,
      message: "voucher otp verification",
      data: { message: "Invalid OTP code" },
    });

  let Voucher =
    voucher_type === "offer_voucher" ? _43d‍.a("USER_VOUCHERS",USER_VOUCHERS) : _43d‍.a("OPEN_VOUCHERS",OPEN_VOUCHERS);
  let user_voucher = Voucher.remove({ _id: voucher, user: owner });

  user_voucher.user = user;
  Voucher.write(user_voucher);

  voucher_type === "open_voucher" &&
    _43d‍.a("VOUCHERS",VOUCHERS).update(user_voucher.voucher, { email: email2, user });

  res.json({
    ok: true,
    message: "transfer voucher",
    data: {
      voucher,
      transferred: true,
    },
  });
};

const verify_voucher = (req, res) => {
  let { email, voucher_code, user, voucher_type } = req.body;
  user = user || _43d‍.a("USERS",USERS).readone({ email: email.toLowerCase() });

  user = (user && user._id) || user;

  let voucher = (
    voucher_type === "offer_voucher" ? _43d‍.a("USER_VOUCHERS",USER_VOUCHERS) : _43d‍.a("OPEN_VOUCHERS",OPEN_VOUCHERS)
  ).readone({ user, voucher_code });

  res.json({
    ok: true,
    message: "verifying voucher",
    data: voucher
      ? {
          state: voucher.state || "unused",
          voucher: { ...voucher, user: _43d‍.a("USERS",USERS).readone(voucher.user) },
          _id: voucher._id,
        }
      : { message: "Voucher not found" },
  });
};

const close_voucher = (req, res) => {
  let { voucher, previous_state, vendor } = req.body;

  let result = _43d‍.a("OFFER_VOUCHERS",OFFER_VOUCHERS).update(
    { _id: voucher, vendor },
    { state: "closed", previous_state: previous_state || "running" }
  );

  res.json({
    ok: true,
    message: "offer closed",
    data: { voucher: result && result._id },
  });
};

const remove_from_closed_voucher = (req, res) => {
  let { voucher, previous_state, vendor } = req.body;

  if (previous_state === "closed") previous_state = "running";

  _43d‍.a("OFFER_VOUCHERS",OFFER_VOUCHERS).update(
    { _id: voucher, vendor },
    { state: previous_state, previous_state: null }
  );

  res.end();
};

/**
 * @api {post} /use_voucher Use Voucher
 * @apiName Use Voucher
 * @apiGroup Vouchers
 *
 * @apiDescription Calling the endpoint, would cause the value of a voucher to be transfered to the stated vendor, provided the call returned a successful response.
 *
 * @apiBody {String} voucher Voucher
 * @apiBody {Number} [value] Only required if voucher is an Open Voucher
 * @apiBody {String} user Owner of said voucher
 * @apiBody {Number} otp Voucher One-Time-Password
 * 
 * @apiSuccessExample {json} Response-Success:
 * {
    ok: true,
    message: "vouchers just got used",
    data: { 
      success: true, 
      voucher: "voucher~9niDNQ1JNUnu~2394201191", 
      vendor: "vendors~p39iDNQiDJNUnu~2394201128", 
      user: "users~uniDNQiDJNUnu~23942012635"
    },
  }
 */
const use_voucher = (req, res) => {
  let { vendor, otp, voucher, value, user } = req.body;

  if (!vendor) {
    vendor = req.header.vendor_id;
  } else {
    if (vendor && !vendor.startsWith("vendor"))
      vendor = reset_vendor_id(vendor);
  }

  if (!otp || Number(otp) !== voucher_otp[voucher])
    return res.json({
      ok: false,
      message: "voucher otp registration failed",
      data: { otp, voucher, message: "Voucher OTP validation failed" },
    });

  voucher = (
    voucher.startsWith("user") ? _43d‍.a("USER_VOUCHERS",USER_VOUCHERS) : _43d‍.a("OPEN_VOUCHERS",OPEN_VOUCHERS)
  ).readone({ _id: voucher, user });

  vendor = _43d‍.a("VENDORS",VENDORS).readone(vendor);

  value = Number(voucher.voucher.vendor ? Number(voucher.value) : value);

  let vendor_value = value - value * 0.05;
  _43d‍.a("WALLETS",WALLETS).update(vendor.wallet, { vouchers: { $inc: vendor_value } });

  let tx = {
    wallet: vendor.wallet,
    voucher: voucher._id,
    customer: user,
    type: "voucher",
    title: "voucher used",
    vendor: vendor._id,
    voucher_code: voucher.voucher_code,
    value: vendor_value,
    credit: true,
    data: voucher._id,
  };

  _43d‍.a("TRANSACTIONS",TRANSACTIONS).write(tx);
  tx.value = value;
  tx.wallet = _43d‍.a("USERS",USERS).readone(user).wallet;
  tx.credit = false;
  _43d‍.a("TRANSACTIONS",TRANSACTIONS).write(tx);

  _43d‍.a("WALLETS",WALLETS).update(_43d‍.a("default_wallet",default_wallet), {
    balance: { $inc: value - vendor_value },
    total_earnings: { $inc: value - vendor_value },
  });

  _43d‍.a("TRANSACTIONS",TRANSACTIONS).write({
    credit: true,
    value: value - vendor_value,
    voucher_code: voucher.voucher_code,
    title: "Offer Voucher Sales Commission",
    wallet: default_wallet,
    type: "voucher",
    user,
    voucher: voucher._id,
  });
  if (voucher.voucher.vendor) {
    _43d‍.a("USER_VOUCHERS",USER_VOUCHERS).update({ user, _id: voucher._id }, { state: "used" });

    _43d‍.a("VOUCHERS",VOUCHERS).update(voucher.voucher._id, { state: "used" });
  } else {
    _43d‍.a("VOUCHERS",VOUCHERS).update(voucher.voucher._id, { value: { $dec: value } });
  }

  res.json({
    ok: true,
    data: { success: true, voucher, vendor, user: _43d‍.a("USERS",USERS).readone(user) },
  });
};

const update_voucher = (req, res) => {
  let voucher = req.body;

  voucher.images = voucher.images.map((img) => {
    img.url = _43d‍.a("save_image",save_image)(img.url);

    return img;
  });

  _43d‍.a("OFFER_VOUCHERS",OFFER_VOUCHERS).update(
    { _id: voucher._id, vendor: voucher.vendor },
    { ...voucher }
  );

  res.json({
    ok: true,
    message: "offer_voucher",
    data: voucher,
  });
};

const voucher_page = (req, res) => {
  let { voucher, vendor } = req.params;

  vendor = _43d‍.a("VENDORS",VENDORS).readone({ uri: vendor });
  if (!vendor) return res.end();

  voucher = _43d‍.a("OFFER_VOUCHERS",OFFER_VOUCHERS).readone({ uri: voucher, vendor: vendor._id });

  voucher
    ? res.json({ ok: true, data: { voucher, vendor: voucher.vendor } })
    : res.end();
};

const voucher_availability = (req, res) => {
  let { uri, vendor } = req.body;

  let v = _43d‍.a("OFFER_VOUCHERS",OFFER_VOUCHERS).readone({ uri, vendor });
  res.json({
    ok: !v,
    data: { available: !v },
  });
};


























;_43d‍.j(["get_offer_vouchers","create_offer_voucher","create_open_voucher","voucher_availability","offer_vouchers","verify_voucher","voucher_page","open_vouchers","update_voucher","voucher_purchased","user_vouchers","redeem_voucher","can_redeem_voucher","request_voucher_otp","transfer_voucher","remove_from_closed_voucher","close_voucher","parse_vendor_id","reset_vendor_id","use_voucher","vendor_id","generate_voucher_otp","unmask_id","mask_id"]);
