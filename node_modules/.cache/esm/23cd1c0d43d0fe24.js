let axios,gds,TRANSACTIONS,USERS,VENDORS,WALLETS,paystack_secret_key,voucher_redeemed_email,send_mail,Paystack_private_key;_43d‍.x([["transactions",()=>transactions],["get_banks",()=>get_banks],["withdraw_wallet",()=>withdraw_wallet],["wallet",()=>wallet],["topup",()=>topup],["rewards",()=>rewards]]);_43d‍.w("axios",[["default",["axios"],function(v){axios=v}]]);_43d‍.w("../ds/conn",[["gds",["gds"],function(v){gds=v}],["TRANSACTIONS",["TRANSACTIONS"],function(v){TRANSACTIONS=v}],["USERS",["USERS"],function(v){USERS=v}],["VENDORS",["VENDORS"],function(v){VENDORS=v}],["WALLETS",["WALLETS"],function(v){WALLETS=v}]]);_43d‍.w("./admin",[["paystack_secret_key",["paystack_secret_key"],function(v){paystack_secret_key=v}]]);_43d‍.w("./emails",[["voucher_redeemed_email",["voucher_redeemed_email"],function(v){voucher_redeemed_email=v}]]);_43d‍.w("./users",[["send_mail",["send_mail"],function(v){send_mail=v}]]);_43d‍.w("./utils",[["Paystack_private_key",["Paystack_private_key"],function(v){Paystack_private_key=v}]]);






const rewards = new Object({
  referral_signup: 2000,
  signup: 1000,
  annual_subscription: 10000,
  daily_reward_claim: 50,
  voucher_redeemed_fee: 100,
  subscription_fee: 15000,
});

const transactions = (req, res) => {
  let { user, wallet, limit, skip } = req.body;

  let txs = _43d‍.a("TRANSACTIONS",TRANSACTIONS).read(null, { skip, limit, subfolder: user || wallet });

  res.json({ ok: true, message: "transactions", data: txs });
};

/**
 *
 * @api {get} /get_banks Get Banks
 * @apiName GetBanks
 * @apiGroup Utils
 *
 * @apiSuccessExample {json} Banks:
 * {
 *  ok: true,
 *  message: 'banks',
 *  data: [
 *   {
 *     active: true,
 *     code: "035A",
 *     country: "Nigeria",
 *     createdAt: "2017-11-15T12:21:31.000Z",
 *     currency: "NGN",
 *     gateway: "emandate",
 *     id: 27,
 *     is_deleted: false,
 *     longcode: "035150103",
 *     name: "ALAT by WEMA",
 *     pay_with_bank: false,
 *     slug: "alat-by-wema",
 *     type: "nuban",
 *     updatedAt: "2022-05-31T15:54:34.000Z"
 *   },
 *   ...
 * ]
 */
const get_banks = (req, res) => {
  _43d‍.a("axios",axios)({
    url: "https://api.paystack.co/bank?currency=NGN",
    headers: {
      Authorization: `Bearer ${_43d‍.a("Paystack_private_key",Paystack_private_key)}`,
    },
    method: "get",
  })
    .then((result) => {
      res.json({ ok: true, message: "Banks", data: result.data.data });
    })
    .catch((e) => _43d‍.g.console.log(e));
};

const withdraw_wallet = (req, res) => {
  let details = req.body;

  let wallet = _43d‍.a("WALLETS",WALLETS).readone(details.wallet);
  if (Number(wallet[details.balance]) < Number(details.amount))
    return res.json({
      ok: false,
      data: { message: "Insufficient wallet balance" },
    });

  let vendor = _43d‍.a("VENDORS",VENDORS).readone(wallet.vendor);
  let user = _43d‍.a("USERS",USERS).readone(vendor.user);
  let { firstname, lastname, email } = user;
  let { bank, amount: value } = details;
  value = Number(value);

  _43d‍.a("axios",axios)({
    url: "https://api.paystack.co/transferrecipient",
    method: "post",
    headers: {
      Authorization: `Bearer ${_43d‍.a("paystack_secret_key",paystack_secret_key)}`,
      "Content-Type": "application/json",
    },
    data: {
      type: "nuban",
      name: `${firstname} ${lastname}`,
      account_number: bank.account_number,
      bank_code: bank.bank.code,
      currency: "NGN",
    },
  })
    .then((result) => {
      result = result.data;

      let recipient = result.data.recipient_code;

      _43d‍.a("axios",axios)({
        url: "https://api.paystack.co/transfer",
        method: "post",
        headers: {
          Authorization: `Bearer ${_43d‍.a("paystack_secret_key",paystack_secret_key)}`,
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        data: {
          source: "balance",
          amount: Number(value) * 100,
          recipient,
        },
      })
        .then((result) => {
          result = result.data;

          let tx = {
            type: "vendor",
            user,
            title: "wallet withdrawn",
            vendor: wallet.vendor,
            value,
            wallet: wallet._id,
          };

          _43d‍.a("WALLETS",WALLETS).update(wallet._id, {
            [details.balance]: { $dec: value },
          });

          _43d‍.a("TRANSACTIONS",TRANSACTIONS).write(tx);

          _43d‍.a("send_mail",send_mail)({
            recipient: email,
            recipient_name: `${firstname} ${lastname}`,
            subject: "[Voucher Africa] Wallet Withdrawn",
            sender: "signup@udaralinksapp.com",
            sender_name: "Voupon",
            sender_pass: "signupudaralinks",
            html: _43d‍.a("voucher_redeemed_email",voucher_redeemed_email)({ ...details }),
          });

          res.json({
            ok: true,
            message: "Wallet withdrawn",
            data: { wallet: wallet._id, amount: value, done: true },
          });
        })
        .catch((err) => _43d‍.g.console.log(err, "HERE"));
    })
    .catch((err) => _43d‍.g.console.log(err, "H#$#"));
};

const wallet = (req, res) => {
  let { user } = req.body;

  user = _43d‍.a("gds",gds).get_folder_by_id(user).readone(user);

  res.json({
    ok: true,
    message: "user wallet",
    data: _43d‍.a("WALLETS",WALLETS).readone(user.wallet),
  });
};

const topup = (req, res) => {
  let { value, wallet } = req.body;

  wallet = _43d‍.a("WALLETS",WALLETS).update(wallet, { balance: { $inc: value } });
  if (!wallet) return res.end();

  let tx = {
    type: "balance",
    user: wallet.user,
    title: "Topup",
    vendor: wallet.vendor,
    value,
    credit: true,
    wallet: wallet._id,
  };

  _43d‍.a("TRANSACTIONS",TRANSACTIONS).write(tx);

  res.json({ ok: false, message: "topup", data: { success: true, value } });
};

;_43d‍.j(["transactions","get_banks","withdraw_wallet","wallet","topup","rewards"]);
